<!-- Libraries -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js" type="text/javascript"></script>
<script src="http://libs.cartocdn.com/cartodb.js/v2/cartodb.js"></script>
<% if(env === 'production') { %>
  <script type="text/javascript" src="js/app.libraries.min.js"></script>
<% } else { %>
  <script type="text/javascript" src="js/lib/underscore.js"></script>
  <!--<script type="text/javascript" src="js/lib/leaflet.js"></script>-->
  <!--<script type="text/javascript" src="js/lib/wax.leaf.js"></script>-->
  <script type="text/javascript" src="js/lib/foundation.js"></script>
  <script type="text/javascript" src="js/lib/foundation.reveal.js"></script>
  <script type="text/javascript" src="js/lib/fastclick.js"></script>
  <script type="text/javascript" src="js/lib/iscroll.js"></script>
<% } %>

<!-- Init Foundation and Fast Click-->
<script type="text/javascript">
  $(document).ready(function(){
    $(document).foundation();
    FastClick.attach(document.body);
  });
</script>

<!-- App Code -->
<% if(env === 'production') { %>
  <script type="text/javascript" src="js/app.min.js"></script>
<% } else { %>
  <script type="text/javascript" src="js/app.js"></script>
<% } %>
<script type="text/javascript">
  // Default settings. Zoom and center overridden by URL params, if they exist
  app.opts = {
    mapContainer: 'map',
    tileURL: 'http://api.tiles.mapbox.com/v3/axisphilly.map-rwfs60dd.jsonp',
    mapOptions: {
      center: [39.987, -75.179],
      zoom: 14,
      minZoom: 11,
      maxZoom: 18,
      maxBounds: [
        [39.69, -76.20],
        [40.60, -74.14]
      ],
      zoomControl: false, // disable default, readded to the topright corner in app#initMap
      urlPosition: false // updates url with center/x/y
    }
  }

  // Kick off map
  app.initMap(function() {
    L.tileLayer('http://{s}.tiles.mapbox.com/v3/axisphilly.map-rwfs60dd/{z}/{x}/{y}.png', {
      attribution: 'Basemap: Data © OpenStreetMap contributors. Design © MapBox'
    }).addTo(app.map);

    app.addCartoDBLayer = function(layerName, year) {
      var layerURL = 'http://axisphilly.cartodb.com/api/v1/viz/combined_shootings_murders/viz.json',
          query = "SELECT * FROM combined_shootings_murders WHERE type = '" + layerName + "'";
      
      if(year !== 'all') {
        query += "' AND YEAR = '" + year + "'"; 
      }

      cartodb.createLayer(app.map, layerURL, {
        query: query
      }).on('done', function(layer) {
        app.cartoDBlayer = layer;
        app.map.addLayer(layer);
      }).on('error', function(error) {
        cartodb.log.log(error);
      });
    }

    app.removeCartoDBLayer = function() {
      app.map.removeLayer(app.cartoDBlayer);
    }

    app.layerName = 'murder';
    app.addCartoDBLayer('murder', 'all');

    $('#shootings').click(function(event){
      if(app.layerName !== 'shooting') {
        app.layerName = 'shooting';
        app.removeCartoDBLayer();
        app.addCartoDBLayer(app.layerName, 'all');
      } 
    });

    $('#murders').click(function(event){
      if(app.layerName !== 'murder') {
        app.layerName = 'murder';
        app.removeCartoDBLayer();
        app.addCartoDBLayer(app.layerName, 'all');
      }
    });

    // iScroll for #year_selector
    var myScroll = new iScroll('year_selector', {
      hScrollbar: false,
      bounce: false
    });

    // scroll propagation fix
    $("#year_selector").on("mousewheel", function(event){ event.preventDefault(); }); // Chrome, Safari and IE8+
    $("#year_selector").on("DOMMouseScroll", function(event){ event.preventDefault(); }); // Firefox 14+
    $("#year_selector").on('MozMousePixelScroll', function(event){ event.preventDefault(); });

    $('.info').click(function(event){
      event.preventDefault();

      $('#infoModal').foundation('reveal', 'open');
    });

    $('.embed').click(function(event){
      event.preventDefault();

      $('#embedModal code').html('<code>&lt;iframe width="100%" height="600" src="' + 
        document.URL + '/embed.html" frameborder="0"></iframe></code>');
      $('#embedModal').foundation('reveal', 'open');
    });
  });
</script>
<!-- modals -->
<div id="embedModal" class="reveal-modal">
  <p>Embed this map on your site by copying and pasting the following code into an article or post:</p>
  <code><script type="text/javascript">window.location</script></code>
  <a class="close-reveal-modal">&#215;</a>
</div>
<div class="description reveal-modal" id="infoModal">
  <h2>Title of map</h2>
  <div class="byline"><span class="byline-author">by <a href="http://axisphilly.org/author/casey/" title="Posts by Casey Thomas" rel="author">Casey Thomas</a>, </span><span class="byline-date">May 20, 2013</span></div>
  Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
  tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
  quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
  consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse
  cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non
  proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
  <a class="close-reveal-modal">&#215;</a>
</div>